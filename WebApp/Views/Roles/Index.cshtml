@using BIVN.FixedStorage.Services.Common.API.Dto.Factory;
@using bivnConstant = BIVN.FixedStorage.Services.Common.API.Constants;

@{
    ViewBag.Title = Html.Translate("Quản lý nhóm quyền");
}

@{
    var DepartmentList = ViewBag.DepartmentList as IEnumerable<DepartmentDto>;
    var FactoryList = ViewBag.FactoryList as IEnumerable<FactoryInfoModel>;

    var message = TempData["RoleResponseModel"]?.ToString() ?? "";
    var currUser = Context.UserFromContext();
}

<section class="@nameof(Views_Roles_Index)">
    @if (Context.User.IsGrant(commonAPIConstant.Permissions.EDIT_INVENTORY))
    {
        <section class="page-heading d-flex justify-content-end">
            <div class="container_modal_add mb-3">
                <button class="btn_add btnNewRole" type="button">
                    <img src="./assets/images/icons/icon-plus.svg">
                    @Html.Translate("Thêm nhóm quyền")
                </button>
            </div>
        </section>
    }

    @{
        var roles = ViewBag.RoleList as IEnumerable<RoleInfoModel>;
        var jsonRolesObject = System.Text.Json.JsonSerializer.Serialize(roles);
    }

    @if(roles?.Any() == true)
    {
        <section id="mainRoles">
            <div class="roles_list">
                @*Các item*@
                @foreach (var role in roles)
                {
                    <div class="role_item h100 rounded role_child px-3 py-2 " data-roleid="@role?.RoleId">
                        <div class="row role_item_heading">
                            <div class="col-9">
                                <h3 class="h4 txt-blue txt-heading roleName txt-14">@role?.Name</h3>
                            </div>
                            <div class="col-3">
                                <div class="row">
                                    <div class="btnEditRole col-6" data-roleid="@role?.RoleId">
                                        <label class="btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M13.6962 5.47381C15.6862 3.48381 17.5862 3.53381 19.5262 5.47381C20.5262 6.46381 21.0062 7.42381 20.9962 8.41381C20.9962 9.37381 20.5162 10.3238 19.5262 11.3038L18.3262 12.5138C18.2462 12.5938 18.1462 12.6338 18.0362 12.6338C17.9962 12.6338 17.9562 12.6238 17.9162 12.6138C15.2662 11.8538 13.1462 9.73381 12.3862 7.08381C12.3462 6.94381 12.3862 6.78381 12.4862 6.68381L13.6962 5.47381ZM15.2762 13.0838C15.5462 13.2438 15.8262 13.3838 16.1162 13.5238C16.1551 13.5407 16.1935 13.5572 16.2315 13.5734C16.5691 13.7175 16.667 14.1629 16.4075 14.4225L10.6862 20.1438C10.5662 20.2738 10.3162 20.3938 10.1362 20.4238L6.29618 20.9638C6.17618 20.9838 6.05618 20.9938 5.93618 20.9938C5.39618 20.9938 4.89618 20.8038 4.53618 20.4538C4.11618 20.0238 3.92618 19.3838 4.02618 18.7038L4.56618 14.8738C4.59618 14.7038 4.71618 14.4538 4.84618 14.3238L10.5746 8.59534C10.8324 8.33758 11.267 8.43503 11.4146 8.76834C11.4345 8.81325 11.455 8.85841 11.4762 8.90381C11.6162 9.18381 11.7562 9.45381 11.9162 9.72381C12.0462 9.94381 12.1862 10.1638 12.3062 10.3138C12.4463 10.5286 12.6038 10.7172 12.7054 10.839C12.7126 10.8476 12.7196 10.8559 12.7262 10.8638C12.7403 10.882 12.7537 10.8994 12.7662 10.9157C12.8156 10.9801 12.8522 11.0279 12.8762 11.0438C13.2062 11.4438 13.5762 11.8038 13.9062 12.0838C13.9862 12.1638 14.0562 12.2238 14.0762 12.2338C14.2662 12.3938 14.4662 12.5538 14.6362 12.6638C14.8462 12.8138 15.0562 12.9538 15.2762 13.0838Z" fill="#87868C"></path>
                                            </svg>
                                        </label>
                                    </div>
                                    <div class="btnDeleteRole col-5" data-roleid="@role.RoleId">
                                        <label class="btn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                                <path d="M21.07 5.23C19.46 5.07 17.85 4.95 16.23 4.86V4.85L16.01 3.55C15.86 2.63 15.64 1.25 13.3 1.25H10.68C8.35001 1.25 8.13 2.57 7.97 3.54L7.76 4.82C6.83001 4.88 5.9 4.94 4.97 5.03L2.93001 5.23C2.51001 5.27 2.21 5.64 2.25 6.05C2.29 6.46 2.65 6.76 3.07 6.72L5.11001 6.52C10.35 6 15.63 6.2 20.93 6.73C20.96 6.73 20.98 6.73 21.01 6.73C21.39 6.73 21.72 6.44 21.76 6.05C21.79 5.64 21.49 5.27 21.07 5.23Z" fill="#E60000"></path>
                                                <path d="M19.23 8.14C18.99 7.89 18.66 7.75 18.32 7.75H5.67999C5.33999 7.75 4.99999 7.89 4.76999 8.14C4.53999 8.39 4.40999 8.73 4.42999 9.08L5.04999 19.34C5.15999 20.86 5.29999 22.76 8.78999 22.76H15.21C18.7 22.76 18.84 20.87 18.95 19.34L19.57 9.09C19.59 8.73 19.46 8.39 19.23 8.14ZM13.66 17.75H10.33C9.91999 17.75 9.57999 17.41 9.57999 17C9.57999 16.59 9.91999 16.25 10.33 16.25H13.66C14.07 16.25 14.41 16.59 14.41 17C14.41 17.41 14.07 17.75 13.66 17.75ZM14.5 13.75H9.49999C9.08999 13.75 8.74999 13.41 8.74999 13C8.74999 12.59 9.08999 12.25 9.49999 12.25H14.5C14.91 12.25 15.25 12.59 15.25 13C15.25 13.41 14.91 13.75 14.5 13.75Z" fill="#E60000"></path>
                                            </svg>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @{
                            var websitePermissions = role?.Permissions?.Where(x => bivnConstant.Permissions.WebSitePermissionList.Contains(x.Name));
                        }
                       
                        <div class="row create_website_access mt-2">
                            <div class="col-12 d-flex justify-content-between">
                                <div>
                                    <label class="txt-bolder txt-12">Website</label>
                                </div>
                                <div>
                                    @{
                                        var isActiveWebsite = role.Permissions.Any(x => x.Name == bivnConstant.Permissions.WEBSITE_ACCESS) ? "checked" : "";
                                    }
                                    <label class="slideon">
                                        <input type="checkbox" class="form-check-input slideon slideon-auto slideon-success" id="website_access" name="permission[]" value="@bivnConstant.Permissions.WEBSITE_ACCESS" @isActiveWebsite disabled>
                                        <span class="slideon-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <ul class="list-unstyled">
                                    @foreach (var permission in bivnConstant.Permissions.WebSitePermissionList)
                                    {
                                        var isActive = websitePermissions?.Any(x => x.Name == permission);
                                        bivnConstant.Permissions.PermissionTitle.TryGetValue(permission, out string title);
                                        var checkColorClass = isActive == true ? "checked_task" : "unchecked_task";
                                        <div class="@checkColorClass">
                                            @if(isActive == true)
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                    <path d="M2 9.46193L5.26903 12.731L14 4" stroke="#17AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            }else
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                  <path d="M12 4L4 12" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                  <path d="M12 12L4 4" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            }
                                            <text class="txt-12">@title</text>
                                        </div>
                                    }
                                </ul>
                            </div>
                        </div>
                    
                        @{
                            var mobilePermissions = role?.Permissions?.Where(x => bivnConstant.Permissions.MobilePermissionList.Contains(x.Name));
                        }
                        
                        <div class="row create_mobile_access">
                            <div class="col-12 d-flex justify-content-between">
                                <div>
                                    <label class="txt-bolder txt-12">App mobile</label>
                                </div>
                                <div>
                                    @{
                                        var isActiveMobile = role.Permissions.Any(x => x.Name == bivnConstant.Permissions.MOBILE_ACCESS) ? "checked" : "";
                                    }
                                    <label class="slideon">
                                        <input type="checkbox" class="form-check-input slideon slideon-auto slideon-success" name="permission[]" value="@bivnConstant.Permissions.MOBILE_ACCESS" @isActiveMobile disabled>
                                        <span class="slideon-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <ul class="list-unstyled">
                                    @foreach (var permission in bivnConstant.Permissions.MobilePermissionList)
                                    {
                                        var isActive = mobilePermissions?.Any(x => x.Name == permission);
                                        bivnConstant.Permissions.PermissionTitle.TryGetValue(permission, out string title);
                                        var checkColorClass = isActive == true ? "checked_task" : "unchecked_task";
                                        <div class="@checkColorClass">
                                            @if(isActive == true)
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                  <path d="M2 9.46193L5.26903 12.731L14 4" stroke="#17AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            }else
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                                  <path d="M12 4L4 12" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                  <path d="M12 12L4 4" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            }
                                            <text class="txt-12">@title</text>
                                        </div>
                                    }
                                </ul>
                            </div>
                        </div>

                        <h5 class="h5 txt-bolder txt-12">@Html.Translate("Phân quyền xem dữ liệu")</h5>
                        @{
                            var viewByDepartmentPermissions = role?.Permissions?.Where(x => x.Category == bivnConstant.Permissions.DEPARTMENT_DATA_INQUIRY);
                        }

                        @{
                            var departmentList = ViewBag.DepartmentList as IEnumerable<DepartmentDto>;
                        }
                        @{
                            var filterDepartmentNames = departmentList?.Where(d => viewByDepartmentPermissions?.Any(x => x.Name == d.Id) == true)
                                    .Select(x => $"{x.Name}");
                        }

                        @if (filterDepartmentNames?.Any() == true)
                        {
                            <div class="check_list">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M2 9.46193L5.26903 12.731L14 4" stroke="#17AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <div>
                                    <text class="txt-12 py-1 txt-green">@Html.Translate("Xem dữ liệu theo phòng ban")</text>
                                    <div class="txt-12 txt-wrap">@Html.Raw(string.Join(", ", filterDepartmentNames))</div>
                                </div>
                            </div>

                        } 
                        @*Nếu không có quyền xem dữ liệu phòng ban nào*@
                        @if (filterDepartmentNames?.Any() == false)
                        {
                            <div class="unchecked_task">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M12 4L4 12" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M12 12L4 4" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <text class="txt-12 py-1">@Html.Translate("Xem dữ liệu theo phòng ban")</text>
                            </div>
                        }

                        @{
                            var viewCreateDocByDepartmentPermissions = role?.Permissions?.Where(x => x.Category == bivnConstant.Permissions.CREATE_DOCUMENT_BY_DEPARTMENT);
                        }

                        @{
                            var createDocDepartmentList = ViewBag.DepartmentList as IEnumerable<DepartmentDto>;
                        }
                        @{
                            var filterCreateDocDepartmentNames = departmentList?.Where(d => viewCreateDocByDepartmentPermissions?.Any(x => x.Name == d.Id) == true)
                            .Select(x => $"{x.Name}");
                        }

                        @if (filterCreateDocDepartmentNames?.Any() == true)
                        {
                            <div class="check_list">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M2 9.46193L5.26903 12.731L14 4" stroke="#17AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <div>
                                    <text class="txt-12 py-1 txt-green">@Html.Translate("Tạo phiếu theo phòng ban")</text>
                                    <div class="txt-12 txt-wrap">@Html.Raw(string.Join(", ", filterCreateDocDepartmentNames))</div>
                                </div>
                            </div>

                        }
                        @*Nếu không có quyền xem dữ liệu phòng ban nào*@
                        @if (filterCreateDocDepartmentNames?.Any() == false)
                        {
                            <div class="unchecked_task">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M12 4L4 12" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M12 12L4 4" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <text class="txt-12 py-1">@Html.Translate("Tạo phiếu theo phòng ban")</text>
                            </div>
                        }


                        @{
                            var viewByFactoryPermissions = role?.Permissions?.Where(x => x.Category == bivnConstant.Permissions.FACTORY_DATA_INQUIRY);
                        }
                        @{
                            var factoryList = ViewBag.FactoryList as IEnumerable<FactoryInfoModel>;
                        }
                        @{
                            var filterFactoryNames = factoryList?.Where(d => viewByFactoryPermissions?.Any(x => x.Name.ToUpper() == d.Id.ToString().ToUpper()) == true)
                            .Select(x => x.Name);
                        }
                        @if (filterFactoryNames?.Any() == true)
                        {
                            <div class="check_list">
                                <div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                        <path d="M2 9.46193L5.26903 12.731L14 4" stroke="#17AE5C" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                </div>
                                <div>
                                    <text class="txt-12 py-1 txt-green">@Html.Translate("Xem dữ liệu theo nhà máy")</text>
                                    <div class="txt-12 txt-wrap">@Html.Raw(string.Join(", ", filterFactoryNames))</div>
                                </div>
                            </div>
                        }

                        @*Nếu không có quyền xem dữ liệu nhà máy nào*@
                        @if (filterFactoryNames?.Any() == false)
                        {
                            <div class="unchecked_task">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <path d="M12 4L4 12" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                    <path d="M12 12L4 4" stroke="#6A707E" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                                </svg>
                                <text class="txt-12 py-1">@Html.Translate("Xem dữ liệu theo nhà máy")</text>
                            </div>
                        }
                    </div>
                }
            </div>
        </section>
    }

    @await Html.PartialAsync("~/Views/Shared/Common/Role/_CreateRoleView.cshtml", new CreateRoleModel{})
    @await Html.PartialAsync("~/Views/Shared/Common/Role/_EditRoleView.cshtml", new EditRoleModel{})
</section>

<script>
    let rolesList = JSON.parse(`@Html.Raw(jsonRolesObject)`);
    var actionMessage = JSON.parse(`@Html.Raw(message)`);
</script>
<script src="./assets/js/RoleManagerment.js" asp-append-version="true"></script>